!function(e){"use strict";const t=[54.514533,36.280053],o="Московская ул., 289, Калуга",n=[54.5635089,36.2609796],s="Калуга",r=["Куровской","Льва Толстого","Мстихино","с. Муратовского щебзавода","Калуга-2","Воротынск","с. Воскресенское","Анненки","Резвань","пос. Юбилейный","д. Бабенки","д. Городня","д. Канищево","д. Лихун","Колюпаново","пос. Ильинка","Пучково","Ромодановские дворики","с. Андреевское","с. Дворцы","с. Плетеневка","с. Росва","Тихонова Пустынь"],i=["rideTime","district","fullName","address","phone"];function a(e){const{address:t,phone:o}=function(e){const t=e.indexOf("+7");let o=-1!==t?e.slice(0,t):e;const n=o.lastIndexOf(",");return o=-1!==n?o.slice(0,n):o,{address:o,phone:-1!==t?e.slice(t):""}}(e[3]);return{rideTime:e[0],district:e[1],fullName:e[2],address:t,phone:o}}function l(e){return i.reduce(((t,o)=>t+e[o]),"")}function c(e){console.log("fullName",e);const[t,o,n]=e.split(" ");return`${t} ${o[0]}. ${n?`${n[0]}.`:""}`}function d(e,t){return{...e,geoObject:t}}function p(e){$(e).parent("li").addClass("active")}function u(e,t,o){return e.some((e=>o.district.toLowerCase().includes(e.toLowerCase())))?`г. ${t}, ${o.district},  ${o.address}`:`г. ${t},  ${o.address}`}function h(e){return e.replace(/\D/g,"")}const m=({errorHelpText:e,formGroup:t,icon:o,touched:n,validity:s})=>{!n||s.valid&&!s.valueMissing?(t.classList.remove("has-error"),t.classList.add("has-success"),o.classList.add("glyphicon-ok"),o.classList.remove("glyphicon-remove"),e.innerText=""):(t.classList.remove("has-success"),t.classList.add("has-error"),o.classList.remove("glyphicon-ok"),o.classList.add("glyphicon-remove"),e.innerText=s.valueMissing?"Телефон обязателен для заполнения":"Введите телефон в формате +7-999-999-99-99")};let g,f;ymaps.ready((function(){!function(){const e=document.querySelector(".loader"),t=document.querySelector(".page-wrapper.container");e.classList.add("hidden"),t.classList.remove("hidden")}(),function(){g=new ymaps.Map("map",{center:t,zoom:12}),ymaps.templateLayoutFactory.createClass("<h2 class=ballon_header>{{ properties.balloonContentHeader|raw }}</h2><div class=ballon_body>{{ properties.balloonContentBody|raw }}</div>");const e=ymaps.templateLayoutFactory.createClass(["<ul class='cluster-list'>","{% for geoObject in properties.geoObjects %}",'<li><a href=# data-placemarkid="{{ geoObject.properties.placemarkId }}" class="list_item">{{ geoObject.properties.balloonContentHeader|raw }}</a></li>',"{% endfor %}","</ul>"].join(""));$(document).on("click",".cluster-item-add-to-route-sheet input",(e=>{const t=+h(e.target.id);g.geoObjects.get(t);const o=g.geoObjects.get(1).getGeoObjects().find((e=>+h(e.properties.get("id"))===t));O(o)||4!==k.length||e.preventDefault(),o.events.fire("click")})),f=new ymaps.Clusterer({preset:"islands#invertedVioletClusterIcons",groupByCoordinates:!0,clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!0,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,clusterHasHint:!0,clusterOpenHintOnHover:!0,clusterOpenEmptyHint:!0,clusterHintContent:"123",clusterBalloonContentLayout:e},{clusterHintContent:"123"}),f.createCluster=function(e,t){let o=ymaps.Clusterer.prototype.createCluster.call(this,e,t);o.getGeoObjects().length;let n=t[0].getAddressLine().split(",");return n.shift(),n=n.join(","),o.properties.set("hintContent",n),o.events.add(["click"],(e=>{e.originalEvent.target.getGeoObjects().forEach((e=>{const t=e.properties.get("employee"),o=+h(e.properties.get("id")),n=k.some((t=>e===t.geoObject));e.properties.set("balloonContentHeader",L(o,c(t.fullName),n))}))})),o},w(g)}(),function(){const t=$("#viewEditorBtn");let n=$("#cke_pasteTimeTableEditor"),i=$("#cke_routeSheets");const d=$("#viewTimeSelectorBtn"),h=$("#timeSelectorModal"),O=$("#send"),H=$(".remove-route"),E=$(".car-fill-progress-window"),P=$(".chart"),I=$("#add"),S=$("#download"),_=$("#modal-message"),B=u.bind(null,r,s);x=x.bind({chart:P,progressWindow:E}),A=A.bind({timeSelectorModal:h}),M=M.bind(_),T=T.bind(_),$('[data-toggle="tooltip"]').tooltip(),G=P,G.easyPieChart({easing:"easeOutBounce",onStep:function(e,t,o){$(this.el).find(".percent").text(Math.round(o))},barColor:"#68b3a5",trackColor:"#f2f2f2",scaleColor:!1,lineWidth:8,size:130,animate:500}),$("#voronezh").bind("click",(function(){haightAshbury=new ymaps.maps.LatLng(51.680647,39.180847),setMapOnAll(null),markers.splice(1,markers.length-1),markers[0].position=haightAshbury,markers[0].title="ЦПК г.Воронеж",markers[0].code="55.751574, 37.573856",setMapOnAll(map),map.setCenter(markers[0].getPosition())})),$("#nino").bind("click",(function(){haightAshbury=new ymaps.maps.LatLng(56.307438,43.988931),setMapOnAll(null),markers.splice(1,markers.length-1),markers[0].position=haightAshbury,markers[0].title="ЦПК г.Нижний Новгород",markers[0].code="55.751574, 37.573856",setMapOnAll(map),map.setCenter(markers[0].getPosition())})),$("#perm").bind("click",(function(){haightAshbury=new ymaps.maps.LatLng(58.009557,56.187656),setMapOnAll(null),markers.splice(1,markers.length-1),markers[0].position=haightAshbury,markers[0].title="ЦПК г.Пермь",markers[0].code="55.751574, 37.573856",setMapOnAll(map),map.setCenter(markers[0].getPosition())})),$("#map").height($(window).height()-$("#header-navbar").height()-$("#footer-bar").height()-20),t.bind("click",(function(){j(),p(this),h.hide(),n=0===n.length?$("#cke_pasteTimeTableEditor"):n,n.toggle(),i.hide(),$("#cke_1_contents").height($(window).height()-$("#header-navbar").height()-$("#footer-bar").height()-200)})),d.bind("click",(function(){j(),p(this),n.hide(),i.hide(),h.toggle()})),O.bind("click",e.debounce((function(){0!==g.geoObjects.getLength()&&(g.geoObjects.removeAll(),f.removeAll(),w(g),b=null);const e=function(e){const t=Array.from(e).find((e=>e.checked));return t?t.value:null}($("#timeSelectorModal input[type='radio']")),t=$("#cke_pasteTimeTableEditor iframe").contents().find("table > tbody > tr");if(!t.length)return void M({bodyText:"Таблица с информацией по сотрудниками не скопирована или таблица некорректного формата"});const o=Array.from(t).filter((t=>t.children[0].innerText.padStart(5,"0")===e));if(!o.length)return void M({bodyText:"Нет сотрудников, записанных на выбранное время"});const n=o.map((e=>Array.from(e.querySelectorAll("td")).map((e=>e.innerText)))).map(a).filter((e=>{const t=l(e);return!v.has(t)}));if(!n.length)return void M({bodyText:"На выбранное время уже сформированы маршрутные листы"});const s=n.map(B);n.forEach(((e,t)=>{ymaps.geocode(s[t]).then((o=>{const n=o.geoObjects.get(0);n.options.set("hasBalloon",!1),n.options.set("hasHint",!0),n.properties.set("balloonContentHeader",L(t,c(e.fullName))),n.properties.set("hintContent",s[t]),n.properties.set("id",`addressMark_${t}`),n.properties.set("employee",e),n.events.add(["click"],A(e,k)),f.add(n),g.geoObjects.add(f)})).catch((e=>console.error(e)))}))}),500)),H.bind("click",(function(){y.setReferencePoints([o]),x();g.geoObjects.get(1).getGeoObjects().forEach((e=>{e.options.set("preset","islands#blueIcon")})),k.length=0})),I.on("click",(()=>{if(k.length){for(k.forEach((e=>{const t=l(e);v.add(t)}));k.length;){const e=k[0];f.remove(e.geoObject),k.shift()}y.setReferencePoints([o]),x()}})),S.on("click",(()=>{M({title:"Телефон дежурного",bodyContent:(e=>{let t=!1;const o=document.createElement("div");o.classList.add("form-group","has-feedback");const n=document.createElement("span");n.classList.add("glyphicon","glyphicon-remove","form-control-feedback");const s=document.createElement("div");s.classList.add("phone-error-text","text-danger");const r=document.createElement("input");return r.autofocus=!0,r.type="tel",r.pattern="^((\\+7)|8)-[0-9]{3}-[0-9]{3}-[0-9]{2}-[0-9]{2}$",r.title="Введите телефон в формате +7-999-999-99-99",r.required=!0,r.classList.add("form-control"),r.addEventListener("input",(r=>{console.log(r),console.log("e.target.validity",r.target.validity),e.employeeOnDutyPhoneNumber=r.target.value,m({errorHelpText:s,formGroup:o,icon:n,touched:t,validity:r.target.validity})})),r.addEventListener("blur",(e=>{t=!0,m({errorHelpText:s,formGroup:o,icon:n,touched:t,validity:e.target.validity})})),o.appendChild(r),o.appendChild(n),o.appendChild(s),o})(C)})}));var G}()}));let b=null,y=null,k=[],v=new Set,C={employeeOnDutyPhoneNumber:""};const O=e=>k.some((t=>t.geoObject===e)),L=(e,t,o=!1)=>{const n=`checkbox-add-to-route-sheet-${e}`;return`<div class='cluster-item-add-to-route-sheet'><input id=${n} type='checkbox' ${o?"checked":""}/><label for=${n}>${t}</label></div>`},w=e=>{e.geoObjects.add(new ymaps.Placemark(n,{balloonContent:"<strong>ЦПК Калуга</strong>",hintContent:"ЦПК Калуга"},{iconColor:"#ff0000"}))};function j(){$(".nav-stacked li").removeClass("active")}function A(e,t){return function(n){const s=n.get("target"),r=s.geometry.getCoordinates();if(this.timeSelectorModal.hide(),!b){const n=[o,r];y=new ymaps.multiRouter.MultiRouteModel(n),b=new ymaps.multiRouter.MultiRoute(y,{wayPointIconFillColor:"red",wayPointVisible:!1,boundsAutoApply:!1}),g.geoObjects.add(b),s.options.set("preset","islands#darkGreenIcon");const i=d(e,s);return t.push(i),void x()}let a=y.getReferencePoints();const l=O(s);if(l||5!==a.length){if(l){const o=a.findIndex((e=>!!Array.isArray(e)&&(r[0]===e[0]&&r[1]===e[1])));a.splice(o,1),s.options.set("preset","islands#blueIcon");const n=t.findIndex((t=>{return o=t,n=e,i.every((e=>o[e]===n[e]));var o,n}));t.splice(n,1)}else{a.push(r),s.options.set("preset","islands#darkGreenIcon");const o=d(e,s);t.push(o)}y.setReferencePoints(a),x()}else alert("нельзя добавить в одну машину больше 4 пассажиров!")}.bind(this)}function x(){const e=y.getReferencePoints();this.progressWindow.css({display:e.length>1?"block":"none"});const t=25*(e.length-1);this.chart.data("easyPieChart").update(t)}function T(){this.find(".modal-body").empty(),this.css({display:"none"})}function M({title:e,bodyText:t="",bodyContent:o,onClose:n}){this.removeClass("fade"),this.css({display:"block"});const s=this.find(".modal-title"),r=this.find(".modal-body"),i=this.find(".modal-header"),a=this.find(".modal-footer button"),l=this.find(".modal-header button");e&&s.text(e),s.css({display:e?"block":"none"}),e?i.removeClass("no-border-bottom"):i.addClass("no-border-bottom"),o?r.append(o):r.text(t),l.on("click",T),a.on("click",(()=>{"function"==typeof n&&n(),T()}))}}(_);
